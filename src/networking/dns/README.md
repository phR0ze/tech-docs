# DNS

Documentation for `systemd-resolved`

### Quick links
* [resolved overview](#resolved-overview)
  * [Modern DNS with nss-resolve](#modern-dns-with-nss-resolve)
  * [Traditional DNS with nss-dns](#traditional-dns-with-nss-dns)
* [DNS routing](#dns-routing)
  * [Default Route](#default-route)
  * [Split DNS](#split-dns)
  * [Add domain route](#add-domain-route)
* [Nameservers](#nameservers)
  * [Quad9 DNS](#quad9-dns)
  * [Cloudflare DNS](#cloudflare-dns)
  * [Google DNS](#google-dns)
  * [DNSSEC Validation Failures](#dnssec-validation-failures)
* [DNS commands](#dns-commands)
  * [DNS status](#dns-status)
  * [DNS lookup](#dns-lookup)
  * [DNS flush](#dns-flush)

## resolved overview

**References**
* [systemd-resolved split dns](https://blogs.gnome.org/mcatanzaro/2020/12/17/understanding-systemd-resolved-split-dns-and-vpn-configuration/)

### Modern DNS with nss-resolve
**/etc/nsswitch.conf**  
Modern `/etc/nsswitch.conf` which controls which `glibc Name Service Switch` (NSS) modules are 
invoked by glibc when performing name resolution now look like:
```
hosts: mymachines resolve [!UNAVAIL=return] files myhostname dns
```
which means first invoke `nss-mymachines` which resolves container names registered with 
`systemd-machined`. Next and most commonly used `nss-resolve` uses `systemd-resolved` to resolve 
hostnames via its `varlink API` as of version 247. Older versions used the D-Bus. Finally 
`[!UNAVAIL=return]` says that if `systemd-resolved` is running stop there even if no result is found. 
Only if resolve is not running then use the traditional `nss-files`, `nss-myhostname` and `nss-dns` 
modules which are now obsoleted on most modern nix systems.

**Note** checking that your `/etc/msswitch.conf` is setup to use `resolve` is the first thing to 
check if `systemd-resolved` doesn't appear to be taking affect. This was the case with Ubuntu which 
doesn't have `resolve` set properly.

**/etc/resolv.conf**  
When `nss-resolve` is used `/etc/resolv.conf` is totally ignored and should just be a link to 
`/run/systemd/resolve/stub-resolv.conf` which is controlled by `systemd-resolved` for apps that 
attempt to do their own DNS resolving.

### Traditional DNS with nss-dns
**/etc/nsswitch.conf**  
Traditionally `/etc/nsswitch.conf` controlled which `glibc Name Service Switch` (NSS) modules are 
invoked by glibc when performing name resolution and looked like:
```
hosts: files mdns4_minimal [NOTFOUND=return] dns myhostname
```
which meant first invoke `nss-files` which looks at `/etc/hosts` to see if the hostname is hardcoded 
there then if not invoke `nss-mdns4_minimal` which uses `avahi` to implement mDNS resolution. 
`[NOTFOUND=return]` allowed for returning early for queries to `.local` domains, which should never 
go to the remaining nss modules. Next and most commonly used DNS resolution is performed by 
`nss-dns`. Finally `nss-myhostname` simply ensures that the local hostname is always resolvable. 
`nss-dns` is what reads `/etc/resolv.conf`.

**/etc/resolv.conf**  
`/etc/resolv.conf` contains a list of up to three DNS servers to use. The servers are attempted in 
order. If the first server in the list is down then the second server will be used and so on. If the 
third server is down DNS won't work as nothing beyond the third is tried. Commonly the file was 
simply a flat file managed by `NetworkManager` and looked like:
```
# Generated by NetworkManager
nameserver 192.168.122.1
```
which simply meant the network was setup via DHCP to your home router by NetworkManger and so then 
NetworkManager added the router IP to your `/etc/resolv.conf`.

## DNS routing
**WARNING**: don't get confused with DNS routing. This is for DNS lookup only and doesn't imply IP 
routing of actual traffic.

[systemd-resolved and VPNs](https://systemd.io/RESOLVED-VPNS/)
There are two flavors of domains attached to a network interface: `routing domains` and `search 
domains`. They both specify that a given domain and any subdomains are appropriate for that 
interface. Search domains have the additional function that single-label names are suffixed with that 
search domain before being resolved e.g. `server` would resolve to `server.example.com` for the 
search domain of `example.com`. In ***systemd-resolved*** config files, routing domains are prefixed 
with the tilda `~` character.

Use resolvectl to see current settings, run: `resolvectl`
```
Global
           Protocols: +LLMNR +mDNS -DNSOverTLS DNSSEC=no/unsupported
    resolv.conf mode: stub
  Current DNS Server: 1.1.1.1
         DNS Servers: 1.1.1.1 1.0.0.1
Fallback DNS Servers: 8.8.8.8 8.8.4.4

Link 2 (eno1)
Current Scopes: none
     Protocols: -DefaultRoute +LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported

Link 3 (enp1s0)
    Current Scopes: DNS LLMNR/IPv4
         Protocols: +DefaultRoute +LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported
Current DNS Server: 1.1.1.1
       DNS Servers: 1.1.1.1 1.0.0.1
```

### Default Route
The `+DefaultRoute` property in the example above is a simple boolean value that may be set on an 
interface to indicate that any DNS lookup for which no matching routing or search domains exist 
should be routed to this interface. If set to `-DefaultRoute` then the DNS servers on this interface 
are not considered for routing lookups except for the ones matched with their searching/routing 
domains. Finally an interface that doesn't have this property is automatically considered for all 
lookups if a match has not been found yet.

### Split DNS
Split DNS is a common way to refer to sending some DNS requests to one DNS name server while sending 
other DNS requests to another DNS name server. A common use case for this is when using a corporate 
VPN to connect to company resources. DNS would be configured to send DNS requests for resources on 
the VPN to use DNS for the VPN. Failure to devide the DNS requests will result in being unable to 
connect to coporate resources on the VPN or worse flowing personal DNS requests over the corporate 
VPN using corporate bandwidth and being scrutinized by corporate IT monitoring.

1. Check that `resolvectrl status tun0` shows your VPN connection with the correct DNS and search domains
   ```
   $ resolvectl status tun0
   Link 8 (tun0)
       Current Scopes: DNS LLMNR/IPv4 mDNS/IPv4
            Protocols: -DefaultRoute +LLMNR +mDNS -DNSOverTLS DNSSEC=no/unsupported
   Current DNS Server: 10.2.3.53
          DNS Servers: 10.2.3.53 10.2.4.54
           DNS Domain: test.company.com foo.company.com
   ```
2. Ensure dns requests to the VPN name servers works e.g. `resolvectl query test.company.com`
   ```bash
   $ resolvectl query test.company.com
   test.company.com: resolve call failed: DNSSEC validation failed: incompatible-server
   ```
   * If you see the `DNSSEC validation error` try turning off DNSSEC first `sudo resolvectl dnssec tun0 off`
   * To persistently fix it add the `services.resolved.dnssec = "allow-downgrades"` 

3. Check that the `/etc/resolv.conf` was automatically updated by Network Manager to contain the search 
   domain you added in the VPN connection e.g. `company.com` as the last entry in the file.
   
   **Example**
   ```
   nameserver 127.0.0.53
   options edns0 trust-ad
   search company.com
   ```
4. Check that `ip route` shows your company.com addressed routed over `tun0`

### Configure DNS for all links
```bash
# Edit resolved config
$ cat /etc/systemd/resolved.conf
[Resolve]
DNS=1.1.1.1 1.0.0.1
FallbackDNS=8.8.8.8 8.8.4.4

# Restart service
$ sudo systemctl restart systemd-resolved
```

### Debug dns
1. Check resolved's configuration, run
   ```
   $ resolvectl
   ```

2. Check the logs
   ```bash
   $ journalctl -u systemd-resolved -b --no-pager
   # or 
   $ journalctl -u systemd-resolved --since="-2 minutes"
   -- Journal begins at Thu 2021-09-16 21:39:04 MDT, ends at Sat 2021-11-20 15:41:19 MST. --
   Nov 20 15:39:29 main4 systemd-resolved[8699]: Using degraded feature set UDP instead of TCP for DNS server 8.8.8.8.
   Nov 20 15:39:35 main4 systemd-resolved[8699]: Using degraded feature set TCP instead of UDP for DNS server 8.8.8.8.
   ```

### Add domain route
In order to get all traffic for `company.com` to resolve over the `tun0` interface you'd need to 
configure a routing domain of `~company.com`. To further only consider this route for `company.com` 
traffic and not other traffic you'd need to add the `default-route: false` property.

**resolvectl** provides a wrapper around the `D-Bus` and can be used to instruct `systemd-resolved` 
dynamically rather than updating the config file statically.
```bash
# Set the routing domains to use
$ sudo resolvectl domain tun0 '~foo1.company.com' '~foo2.company.com'

# Set the nameserver to use excplicitly
$ sudo resolvectl dns tun0 192.0.2.1
```

## Nameservers

### Cloudflare DNS
[Cloudflare's DNS](https://blog.cloudflare.com/announcing-1111/) heralded as the Internet's fastest,
privacy-first consumer DNS service.

* ***1.1.1.1***
* ***1.0.0.1***

### Quad9 DNS
[Quad9's DNS](https://quad9.net/) is a DNS service founed by IBM and a few others with the primary
unique feature of a malicious blocklist.

* ***9.9.9.9***
* ***9.9.9.10***

### Google DNS
[Google DNS](https://developers.google.com/speed/public-dns/) claims to speed up browsing and offer
better security, however nothing is called out around privacy as they like to monitor heavily.

* ***8.8.8.8***
* ***8.8.4.4***

### DNSSEC Validation Failures
After updating to the latest bits 5.2.11 kernel for reference I started getting DNS failures:

```bash
# Check the status of systemd resolved
$ sudo systemctl status systemd-resolved
...
Sep 02 20:04:08 main4 systemd-resolved[668]: DNSSEC validation failed for question io IN DS: signature-expired
...
```

Apparently DNSSEC is known to fail and the work around is to turn it off.
https://wiki.archlinux.org/index.php/Systemd-resolved#DNSSEC

```bash
# /etc/systemd/resolved.conf.d/dnssec.conf
# [Resolve]
# DNSSEC=false

# Then restart the service
$ sudo systemctl restart systemd-resolved
```

## DNS commands

### DNS status
```bash
$ resolvectl status
```

### DNS lookup
```bash
$ resolvectl query archlinux.org
```

### DNS flush
Flushes all DNS resource record caches the service maintains locally
```bash
$ sudo resolvectl flush-caches
```

<!-- 
vim: ts=2:sw=2:sts=2
-->
